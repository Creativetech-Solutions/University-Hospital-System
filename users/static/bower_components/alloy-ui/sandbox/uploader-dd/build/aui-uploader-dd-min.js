AUI.add("aui-uploader-dd",function(E){var K=E.Lang,D=K.isFunction,F=E.ClassNameManager.getClassName,R="uploaderdd",B="input[type=file]",M=F("helper","hidden"),J=F(R,"html"),H=F(R,"image"),P='<{0} id="{1}" class="'+J+'"><form></form></{0}>',G='<div id="{0}" class="'+H+'"><a href="javascript://"><form></form></a></div>',L='<input type="file" />',O="#{0} a [ width: {2}px; height: {3}px; background: url({1}) 0 0 no-repeat; ]"+"#{0} a:hover [ background-position: 0 -{3}px; ]"+"#{0} a:active [ background-position: 0 -{4}px; ]",C="--{0}--",N="--{0}\r\n"+'Content-Disposition: form-data; name="{1}"\r\n'+"\r\n{2}\r\n",I="--{0}\r\n"+'Content-Disposition: form-data; name="{1}"; filename="{2}"\r\n'+"Content-Type: application/octet-stream\r\n";var Q=E.Component.create({NAME:R,EXTENDS:E.Uploader,ATTRS:{container:{value:null},disableXHR:{value:false,writeOnce:"initOnly"},fileFilters:{value:[],setter:function(Y){var A=this;var X=Y;var S=[];if(X){for(var V=0;V<X.length;V++){var W=X[V].extensions;if(W){W=W.split(";");for(var U=0;U<W.length;U++){var T=K.trim(W[U]);if(T.length){T=T.replace(/\./g,"\\.");T=T.replace(/\*/g,"(.*?)");T="^"+T+"$";S.push(T);}}}}}A._fileFiltersRegExp=(S.length?S:null);Q.superclass.setFileFilters.apply(A,arguments);return Y;}},fileList:{value:{}},filePostName:{value:null},fileSizeLimit:{value:null},generateNewId:{value:false}},constructor:function(S){var A=this;if(S.boundingBox){A._content=E.one(S.boundingBox).cloneNode(true);}Q.superclass.constructor.apply(A,arguments);},prototype:{initializer:function(){var A=this;A.set("container",E.one(A.get("boundingBox")));var V=A.uploaderswf;var T=V._swfId||V._id;A._swf=E.one("#"+T);if(A.canSupportXHR()&&!A.get("disableXHR")){A._renderFileSelect();A._initializeUploader();}else{if(!A.get("buttonSkin")){var S=A.get("container");S.append(A._content.html());S.addClass(J);var U=A._swf;U.setStyle("width",S.get("offsetWidth"));U.setStyle("height",S.get("offsetHeight"));A._bindMouseEvents(S);}A.on("fileselect",A._onFileSelect,A);A.on(["uploadcomplete","uploaderror","uploadcancel"],A._onUploadComplete,A);}A._xhr={};A._queueList=[];A._totalFileCount=0;},cancel:function(S){var A=this;if(A._isSwfVisible()){return Q.superclass.cancel.apply(A,arguments);}else{if(A._xhr[S]){A._xhr[S].abort();return true;}return false;}},cancelAll:function(){var A=this;var U=0;if(A._isSwfVisible()){var S=A.get("fileList");for(var T in S){A.cancel(T);U++;}}else{A._queueList=[];for(var T in A._xhr){A._xhr[T].abort();U++;}}return U;},canSupportDD:function(){var A=this;return("draggable" in document.createElement(A.get("container").get("tagName")));},canSupportXHR:function(){var A=this;return(window.XMLHttpRequest&&window.FileReader);},clearFileList:function(){var A=this;A.set("fileList",{});return Q.superclass.clearFileList.apply(A,arguments);},disable:function(){var A=this;var S=A._fileSelect;if(S){S.all(B).attr("disabled",true);}return Q.superclass.disable.apply(A,arguments);},enable:function(){var A=this;var S=A._fileSelect;if(S){S.all(B).attr("disabled",false);}return Q.superclass.enable.apply(A,arguments);},removeFile:function(S){var A=this;var T=A.get("fileList");delete T[S];if(A._isSwfVisible()){return Q.superclass.removeFile.apply(A,arguments);}},upload:function(U,T,A,X,c){var Y=this;if(Y._isSwfVisible()){Q.superclass.upload.apply(Y,arguments);}else{var Z=Y.get("fileList");var V=Z[U]||Y._getQueuedById(U);if(Y._xhr[U]){Y._removeFile(V);return true;}if(V){var b=Y.get("simLimit");var S=Y._getXHRCount();if(S<b){var a=new XMLHttpRequest();a._uploaderDD={file:V,fileId:U,fileName:c,instance:Y,postVars:X};Y._xhr[U]=a;a.addEventListener("readystatechange",E.bind(Y._doReadyStateChangeXHR,a),false);a.upload.addEventListener("progress",E.bind(Y._doProgressXHR,a),false);a.upload.addEventListener("error",E.bind(Y._doErrorXHR,a),false);a.upload.addEventListener("abort",E.bind(Y._doAbortXHR,a),false);a.upload.addEventListener("load",E.bind(Y._doLoadXHR,a),false);a.open((A?A:"POST"),T,true);var W=new FileReader();if(D(W.addEventListener)){W.addEventListener("loadend",E.bind(Y._doLoadEndXHR,a),false);}else{W.onloadend=E.bind(Y._doLoadEndXHR,a);}W.readAsBinaryString(V);Y._removeFile(V);Y.fire("uploadstart",{id:U,type:"uploadstart"});}else{if(Y._getQueueIndex(U)==-1){Y._queueList.push({arguments:arguments,file:V,id:U});}}delete Z[U];return true;}}return false;},uploadAll:function(V,X,T,W){var A=this;if(A._isSwfVisible()){return Q.superclass.uploadAll.apply(A,arguments);}else{var U=A.get("fileList");for(var S in U){A.upload(S,V,X,T,W);}return true;}},uploadThese:function(U,T,X,S,W){var A=this;if(A._isSwfVisible()){return Q.superclass.uploadThese.apply(A,arguments);}else{if(U){for(var V=0;V<U.length;V++){A.upload(U[V],T,X,S,W);}}return true;}return false;},_addFile:function(a){var Y=this;if(a instanceof File){var Z=Y.get("fileList");var S=Y._getFileCount();if(Y.get("multiFiles")||S==0){var A="file"+(Y.get("generateNewId")?Y._getNewId():S);var b=false;var X=Y._fileFiltersRegExp;if(X){var T=a.name;for(var U=0;U<X.length;U++){var W=new RegExp(X[U],"gi");if(W.test(T)){b=true;break;}}}else{b=true;}if(b){var V=Y.get("fileSizeLimit");if(!V||a.size<=V){while(Z[A]||Y._getQueueIndex(A)!=-1){S++;A="file"+S;}a.id=A;Z[A]=a;Y._totalFileCount++;return true;}else{Y.fire("filesizeerror",{file:a,type:"filesizeerror"});return null;}}}}return false;},_appendInputFile:function(U){var A=this;var S=A._fileSelect;var V=S.one("form");var T=E.Node.create(K.sub(L,[(A.get("multiFiles")?"true":"false")]));if(U){T.setStyle("width",U);}V.append(T);},_bindMouseEvents:function(S){var A=this;var T=E.bind(A._fireEvent,A);S.on("click",T);S.on("mousedown",T);S.on("mouseup",T);S.on("mouseleave",T);S.on("mouseenter",T);},_doAbortXHR:function(V){var A=this;var W=A;var U=W._uploaderDD;var S=U.fileId;var T=U.file;A=U.instance;A._removeXHR(S);A.fire("uploadcancel",{id:S,type:"uploadcancel"});A._sendQueued();},_doErrorXHR:function(V){var A=this;var W=A;var U=W._uploaderDD;var S=U.fileId;var T=U.file;A=U.instance;A._removeXHR(S);A.fire("uploaderror",{id:S,type:"uploaderror"});
A._sendQueued();},_doLoadEndXHR:function(A){var b=this;var c=b;var T=c._uploaderDD;var Y=T.fileName;var W=T.postVars;var d=A.currentTarget.result;var S=D(c.sendAsBinary);var X=[];b=T.instance;var U="__"+new Date().getTime()+"__";if(W){for(var Z in W){X.push(K.sub(N,[U,Z,W[Z]]));}}if(!S){d=btoa(d);}var V=b.get("filePostName");if(V==null||V==""){V=T.fileId;}X.push(K.sub(I,[U,V,(Y!=null?Y:T.file.name)]));X.push("\r\n");X.push(d);X.push("\r\n");X.push(K.sub(C,[U]));c.setRequestHeader("Content-Type","multipart/form-data; boundary="+U);var a=X.join("");if(S){c.sendAsBinary(a);}else{c.send(a);}},_doLoadXHR:function(U){var A=this;var V=A;var T=V._uploaderDD;var S=T.fileId;A=T.instance;A._removeXHR(S);A.fire("uploadcomplete",{id:S,type:"uploadcomplete"});A._sendQueued();},_doProgressXHR:function(U){var A=this;if(U.lengthComputable){var V=A;var T=V._uploaderDD;var S=T.fileId;A=T.instance;A.fire("uploadprogress",{bytesLoaded:U.loaded,bytesTotal:U.total,id:S,type:"uploadprogress"});}},_doReadyStateChangeXHR:function(A){var Y=this;var Z=Y;var S=Z._uploaderDD;var U=S.fileId;var X=A.currentTarget;var V=S.file;Y=S.instance;if(X.readyState==4){var W=X.status;var T=(X.responseXML!=null?X.responseXML:X.responseText);if((W>=200&&W<300)||W===1223){if(T!=null){Y.fire("uploadcompletedata",{data:T,id:U,status:W,type:"uploadcompletedata"});}}else{Y.fire("uploaderror",{data:T,id:U,status:W,type:"uploaderror"});}}},_fireEvent:function(S){var A=this;A.fire(S.type,S);},_getFileCount:function(){var A=this;return A._getItemCount(A.get("fileList"));},_getItemCount:function(S){var A=this;var U=0;if(S){for(var T in S){U++;}}return U;},_getQueuedById:function(T){var S=this;var A=S._queueList;var U=S._getQueueIndex(T);return(U!=-1?A[U].file:null);},_getQueueIndex:function(T){var S=this;var A=S._queueList;for(var U=0;U<A.length;U++){if(A[U].id==T){return U;}}return -1;},_getQueueLength:function(){var S=this;var A=S._queueList;var U=0;if(A){for(var T=0;T<A.length;T++){if(!A[T].sent){U++;}}}return U;},_getNewId:function(){var A=this;return A._totalFileCount;},_getXHRCount:function(){var A=this;return A._getItemCount(A._xhr);},_isSwfVisible:function(){var A=this;var S=A._swf;return(S?!S.hasClass(M):false);},_onDragEnter:function(S){var A=this;S.stopPropagation();S.preventDefault();A.fire("dragenter",S);},_onDragOver:function(S){var A=this;S.stopPropagation();S.preventDefault();A.fire("dragover",S);},_onDrop:function(V){var S=this;V.stopPropagation();V.preventDefault();var A=V._event;if(A.dataTransfer){var U=A.dataTransfer.files;if(U){for(var T=0;T<U.length;T++){S._addFile(U[T]);}}S.fire("fileselect",{fileList:S.get("fileList")});}S.fire("drop",V);},_onFileSelect:function(U){var A=this;var S=A.get("fileList");var V=U.fileList;for(var T in V){S[T]=V[T];}},_onUploadComplete:function(U){var A=this;var S=U.id;var T=A.get("fileList");delete T[S];A.removeFile(S);},_removeFile:function(W){var A=this;var U=A.get("fileList");for(var V in U){if(U[V]==W){delete U[V];break;}}if(A._queueList.length){var T=A._getQueueIndex(W.id);var S=true;A._queueList[T].sent=true;for(var V=0;V<A._queueList.length;V++){if(!A._queueList[V].sent){S=false;break;}}if(S){A._queueList=[];}}},_removeXHR:function(S){var A=this;delete A._xhr[S];},_renderFileSelect:function(){var c=this;if(!c._fileSelect){var U=c.get("container");var b=c.get("buttonSkin");var S=E.guid();var T;var Z;var Y;if(b){Z=E.Node.create(K.sub(G,[S]));U.append(Z);var V=U.get("offsetHeight");var X=K.sub(O,[S,b,U.get("offsetWidth"),V,(V*2)]);X=X.replace(/\[/g,"{");X=X.replace(/\]/g,"}");var A=new E.StyleSheet(X);T=U;Y=T.get("offsetWidth");}else{var e=(U.getComputedStyle("display")=="block"?"div":"span");Z=E.Node.create(K.sub(P,[e,S]));var a=U.ancestor();a.insert(Z,U);U.append(c._content.html());Z.append(U);T=Z;Y=U.get("offsetWidth");}c._fileSelect=Z;c._toggleSwf(false);var d=c.get("multiFiles");var W=Z.one("form");var V=T.get("offsetHeight");do{c._appendInputFile(Y);}while(W.get("offsetHeight")<V);W.delegate("change",function(h){var f=this;var g=h.currentTarget.get("files");E.some(g._nodes,function(l,k,m){var j=f._addFile(l);if(j==false){return true;}});f.fire("fileselect",{fileList:f.get("fileList")});var i=h.target;if(i){i.remove(true);f._appendInputFile(Y);}},B,c);c.publish("dragenter");c.publish("dragover");c.publish("dragleave");c.publish("drop");c.publish("fileselect");c.publish("uploadprogress");c.publish("uploadcomplete");c.publish("uploadcompletedata");c.publish("uploaderror");c.publish("uploadcancel");c.publish("uploadstart");c.publish("filesizeerror");c.publish("click");c.publish("mousedown");c.publish("mouseup");c.publish("mouseleave");c.publish("mouseenter");c._bindMouseEvents(T);if(c.canSupportDD()){T.on("dragenter",c._onDragEnter,c);T.on("dragover",c._onDragOver,c);T.on("dragleave",c._fireEvent,c);T.on("drop",c._onDrop,c);}}},_sendQueued:function(){var S=this;var A=S._queueList;for(var T=0;T<A.length;T++){if(!A[T].sent){S.upload.apply(S,A[T].arguments);}}},_toggleSwf:function(T){var A=this;var U=A._swf;if(U){var S=A._fileSelect;if(T==null){T=!A._isSwfVisible();}A.clearFileList();if(T){U.show();if(S){S.hide();}}else{if(S){U.hide();S.show();}}}},}});E.UploaderDD=Q;},"@VERSION@",{requires:["aui-base","stylesheet","uploader"],skinnable:true});