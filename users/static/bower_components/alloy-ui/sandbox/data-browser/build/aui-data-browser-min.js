AUI.add("aui-data-browser",function(E){var G=E.Lang,H=G.isArray,C=G.isString,B=G.isNull,D=G.isFunction,F=E.ClassNameManager.getClassName,M="databrowser",K="searchView",I="treeView";ALERT="alert",ICON="icon",IMAGE="image",INPUT="input",LOADING="loading",RENDERED="rendered",SEARCH="search",TEXT="text",TREE="tree",ICON_FOLDER="folder-open",ICON_DEFAULT="search",ICON_ERROR=ALERT,ICON_LOADING=LOADING,isResultItem=function(A){return A.hasClass(CSS_RESULTS_ITEM);},isTreeView=function(A){return(A instanceof E.TreeView);},isTreeNodeItem=function(A){return A.hasClass("aui-tree-node");},CSS_RESULTS_ITEM=F(M,"results","item"),CSS_SEARCH=F(M,SEARCH),CSS_SEARCH_LIST=F(M,SEARCH,"list"),CSS_SEARCH_LIST_ITEM=F(M,SEARCH,"list","item"),CSS_TREE=F(M,TREE),KEY_ENTER=13,BOUNDING_BOX="boundingBox",CONTENT_BOX="contentBox",TPL_SEARCH='<div class="'+CSS_SEARCH+'"></div>',TPL_SEARCH_LIST='<ul class="'+CSS_SEARCH_LIST+'"></ul>',TPL_SEARCH_LIST_ITEM='<li class="'+CSS_RESULTS_ITEM+" "+CSS_SEARCH_LIST_ITEM+'-{1}">{0}</li>',TPL_SEARCH_LIST_ITEM_IMAGE='<img src="{2}" title="{1}" alt="" /><div>{0}</div>',TPL_SEARCH_LIST_ITEM_ICON='<span class="{2}" title="{1}"></span><div>{0}</div>',TPL_SEARCH_LIST_ITEM_TEXT='<div title="{1}">{0}</div>',TPL_TREE='<div class="'+CSS_TREE+'"></div>';function J(A,O,P){if(O&&!O.hasChildNodes()){var N={cfg:(!isTreeView(O)?O._originalConfig:null),callback:{success:E.bind(function(R){var Q=this;Q._populateTreeView(E.mix(R,{node:O}));},A),failure:E.bind(function(R){var Q=this;Q._handleResponse(R);},A)}};A.fire("dataRequest",null,N);P.sendRequest(N);}}var L=E.Component.create({ATTRS:{autoLoad:{value:true},currentView:{value:SEARCH},dataSource:{value:null,getter:function(){var A=this;var O=[];if(A.get(RENDERED)){var P=A.get(K);if(P){O[SEARCH]=P.dataSource;}var N=A.get(I);if(N){O[TREE]=N.dataSource;}}return O;}},displayName:{value:false},rootLabel:{value:""},searchView:{value:null},treeView:{value:null}},NAME:M,prototype:{initializer:function(){var A=this;A._createDataSource();var P=A.get(K);var N=A.get(I);var O=A.get("currentView");if(!N&&O==TREE){A.set("currentView",SEARCH);}else{if(!P&&O==SEARCH){A.set("currentView",TREE);}}},bindUI:function(){var A=this;var R=A.get(K);var O=A.get(I);if(R){var N=A.buttonSearch;var P=A.inputNode;R.dataSource.on("request",E.bind(N.set,N,ICON,ICON_LOADING));P.on("focus",A._onTextboxFocus,A);P.on("keydown",A._onTextboxKeyDown,A);if(O){var Q=A.buttonTree;O.dataSource.on("request",E.bind(Q.set,Q,ICON,ICON_LOADING));}}A.publish("dataError");A.publish("dataRequest");A.publish("dataReturn");A.publish("textboxFocus");A.publish("textboxKey");A.publish("itemSelected");A.publish("itemError");},renderUI:function(){var A=this;var N=A.get(CONTENT_BOX);if(A.get(K)){A._renderInput();var Q=E.Node.create(TPL_SEARCH);Q.hide();N.append(Q);A._searchViewEl=Q;}var O=A.get(I);if(O){var R=O.dataSource;var P=E.Node.create(TPL_TREE);P.hide();N.append(P);O=new E.TreeView({boundingBox:P}).render();O.on("expand",function(T){var S=T.tree.node;J(A,S,R);});A._treeView=O;A._treeViewEl=P;}N.delegate("click",function(T){var S=T.currentTarget;if(isResultItem(S)){var U=null;if(isTreeNodeItem(S)){S=E.Widget.getByNode(S);if(S){U=S._originalConfig;}}else{U=S.getData(M);}if(U){A.fire("itemSelected",{node:S,item:U});}else{A.fire("itemError",T);}}},"."+CSS_RESULTS_ITEM);},syncUI:function(){var A=this;var Q=A.get(K);var N=A.get(I);var P=A.get("currentView");var O=A.get("autoLoad");if(O){if(P==SEARCH){if(Q){A._generateQuery();}}else{if(P==TREE){if(N){A._loadTreeView();}}}}A._syncResultViews();A._toggleView();},doBeforeLoadData:function(A){return true;},handleResponse:function(P){var N=this;var Q=N.get("currentView");var A=null;if(P.error){A=ICON_ERROR;}if(Q==SEARCH){var O=N.buttonSearch;if(!P.error){A=ICON_DEFAULT;}else{N._query=null;}O.set(ICON,A);}else{if(Q==TREE){var O=N.buttonTree;if(O){if(!P.error){A=ICON_FOLDER;}O.set(ICON,A);}}}},generateRequest:function(N){var A=this;return{request:N,callback:{success:E.bind(function(P){var O=this;O._populateSearchView(P);},A),failure:E.bind(function(P){var O=this;O._handleResponse(P);},A)}};},_createDataSource:function(){var S=this;var T=[S.get(K),S.get(I)];for(var Q=0;Q<T.length;Q++){if(T[Q]){var A=T[Q].dataSource;var P=A;var U=T[Q].dataSourceType;var O=T[Q].schema;var N=T[Q].schemaType;if(!(A instanceof E.DataSource.Local)){if(!U){U="Local";if(D(P)){U="Function";}else{if(C(P)){U="IO";}}}A=new E.DataSource[U]({source:P});}A.on("error",S.handleResponse,S);A.after("response",S.handleResponse,S);U=A.name;if(U=="dataSourceLocal"){S.set("applyLocalFilter",true);}T[Q].dataSource=A;T[Q].dataSourceType=U;if(O){if(O.fn){T[Q].dataSource.plug(O);}else{var R={array:E.Plugin.DataSourceArraySchema,json:E.Plugin.DataSourceJSONSchema,text:E.Plugin.DataSourceTextSchema,xml:E.Plugin.DataSourceXMLSchema};N=(N?N.toLowerCase():"array");T[Q].dataSource.plug({fn:R[N],cfg:{schema:O}});}}T[Q].schema=O;}}},_generateQuery:function(O){var A=this;var R=A.get("currentView");var N=A.inputNode;var Q=A._query;var P=N.get("value");if(R==TREE&&(P!=""&&Q==P)){A.set("currentView",SEARCH);A._toggleView();}else{this._sendQuery(P);}},_loadTreeView:function(){var A=this;var N=A.get(I);J(A,A._treeView,N.dataSource);},_onTextboxFocus:function(N){var A=this;if(!A.get("focused")){A.focus();A._initInputValue=A.inputNode.get("value");A.fire("textboxFocus");}},_onTextboxKeyDown:function(N){var A=this;var O=N.keyCode;switch(O){case KEY_ENTER:A._generateQuery(N);break;default:A.fire("textboxKey",O);break;}A._keyCode=O;},_populateSearchView:function(Y){var d=this;var N=Y.response;var T=d.doBeforeLoadData(Y);if(T&&!Y.error){d.set("currentView",SEARCH);d.fire("dataReturn",Y);var W=d.get(K);var P=d.get("displayName");var a=N.results;var V=(W.schema?W.schema.resultFields:null);var Q=W.folderKey;if(!Q&&V){Q=V[0];}else{Q=Q||0;}var S=[];var A=[];var e=[];var R=0;for(var Z=0;Z<a.length;Z++){var h=a[Z][Q];if(h!=null){if(S[h]!=null){A[S[h]].data.push(a[Z]);}else{S[h]=R;A[R]={name:h,data:[a[Z]]};R++;}}else{e.push(a[Z]);}}A.sort(function(j,i){return(j.data.length==i.data.length?0:(j.data.length>i.data.length?-1:1));
});if(e.length>0){A.push({name:"",data:e});}d._searchViewEl.html("");for(var Z=0;Z<A.length;Z++){var U=E.Node.create(TPL_SEARCH_LIST);for(var X in A[Z].data){var f=A[Z].data[X];var g=null;var b=null;var O=null;if(f.imageUri){g=TPL_SEARCH_LIST_ITEM_IMAGE;b=f.imageUri;O=IMAGE;}else{if(f.iconCss){g=TPL_SEARCH_LIST_ITEM_ICON;b=f.iconCss;O=ICON;}else{g=TPL_SEARCH_LIST_ITEM_TEXT;O=TEXT;}}g=G.sub(TPL_SEARCH_LIST_ITEM,[G.sub(g,[(P?f.name:""),f.title||"",b||""]),O]);var c=E.Node.create(g);c.setData(M,f);U.append(c);}new E.Panel({collapsible:true,collapsed:(d._searchViewEl.html()!=""),headerContent:A[Z].name,bodyContent:U}).render(d._searchViewEl);}this._toggleView();}},_populateTreeView:function(A){var U=this;var P=A.response;var O=A.node;var S=U.doBeforeLoadData(A);if(S&&!A.error&&O!=null){U.set("currentView",TREE);U.fire("dataReturn",A);var Q=P.results;if(Q.length>0){function R(W){for(var V in W){if(W[V].children||(W[V].leaf!=undefined&&!W[V].leaf)){R(W[V].children);}else{W[V].cssClass=(W[V].cssClass?" ":"")+CSS_RESULTS_ITEM;}}}R(Q);var T=U.get("rootLabel");if(T&&isTreeView(O)){var N=new E.TreeNode({label:T,children:Q});O.appendChild(N);}else{E.each(Q,function(V){var W=O.createNode.apply(U,[V]);O.appendChild(W);});}}this._toggleView();}else{U.fire("dataError",A);}},_renderInput:function(){var S=this;var O=S.get(CONTENT_BOX);var Q=S.get("input");var A=S.get(I);var P={field:{labelText:false},icons:[{icon:ICON_DEFAULT,handler:{fn:S._generateQuery,context:S}}]};if(A){P.icons.push({icon:ICON_FOLDER,handler:{fn:function(){var V=this;V.set("currentView",TREE);V._loadTreeView();V._toggleView();},context:S}});}var T=null;var U=null;if(Q){Q=E.one(Q);P.field.node=Q;T=Q.next();U=Q.get("parentNode");}var R=new E.Combobox(P).render(O);if(U){var N=R.get("boundingBox");U.insertBefore(N,T);}S.comboBox=R;S.inputNode=R.get("node");S.buttonSearch=R.icons.item(0);if(A){S.buttonTree=R.icons.item(1);}S.set("uniqueName",E.stamp(S.inputNode));},_sendQuery:function(O){var A=this;var Q=A.get(K);var P=Q.dataSource;O=encodeURIComponent(O);var N=A.generateRequest(O);A.fire("dataRequest",O,N);P.sendRequest(N);A._query=O;},_syncResultViews:function(){var S=this;var U=S.get("height");if(U){var O=S.get(BOUNDING_BOX);var A=S._searchViewEl;var P=S._treeViewEl;var R=S.comboBox;var N=0;if(R){var T=R.get(BOUNDING_BOX);N+=(parseFloat(T.getComputedStyle("marginTop"))+parseFloat(T.getComputedStyle("borderTopWidth"))+T.getDOM().offsetHeight+parseFloat(T.getComputedStyle("borderBottomWidth"))+parseFloat(T.getComputedStyle("marginBottom")));}var V=parseInt(S.get("height"))-N;if(A){var Q=(parseFloat(A.getComputedStyle("borderTopWidth"))+parseFloat(A.getComputedStyle("paddingTop"))+parseFloat(A.getComputedStyle("paddingBottom"))+parseFloat(A.getComputedStyle("borderBottomWidth")));A.setStyle("height",(V-Q)+"px");}if(P){var Q=(parseFloat(P.getComputedStyle("borderTopWidth"))+parseFloat(P.getComputedStyle("paddingTop"))+parseFloat(P.getComputedStyle("paddingBottom"))+parseFloat(P.getComputedStyle("borderBottomWidth")));P.setStyle("height",(V-Q)+"px");}}},_toggleView:function(){var A=this;var P=A.get("currentView");var O=A._searchViewEl;var N=A._treeViewEl;if(P==SEARCH){if(N){N.hide();}if(O){O.show();}}else{if(P==TREE){if(O){O.hide();}if(N){N.show();}}}}}});E.DataBrowser=L;},"@VERSION@",{requires:["aui-base","aui-tree","aui-panel","datasource","dataschema","aui-form-combobox"],skinnable:true});